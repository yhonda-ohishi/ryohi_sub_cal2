# 機能仕様書: ルーターモジュール

## 概要
ryohi_sub_calシステムのメインエントリーポイントとして機能するルーターモジュールを作成する。各サブモジュールや外部サービスへのルーティングとプロキシ機能を提供する。

## ユーザーストーリー

### ストーリー1: APIゲートウェイ
**として** システム管理者  
**したい** すべての受信リクエストを管理する中央ルーターを持ちたい  
**なぜなら** トラフィックフローを制御し、横断的関心事を一箇所で実装できるから

### ストーリー2: サービスルーティング
**として** 開発者  
**したい** パスパターンに基づいて適切なサービスにリクエストをルーティングしたい  
**なぜなら** 異なるモジュールを独立して開発・デプロイできるから

### ストーリー3: 負荷分散
**として** 運用エンジニア  
**したい** 複数のサービスインスタンス間でトラフィックを分散したい  
**なぜなら** システムが高負荷に対応し、冗長性を提供できるから

## 機能要件

### コアルーティング
1. **HTTPリクエストルーティング**: URLパターンに基づいて受信HTTPリクエストをルーティング
2. **サービスディスカバリー**: 利用可能なバックエンドサービスのレジストリを維持
3. **リクエストプロキシ**: 適切なバックエンドサービスにリクエストを転送
4. **レスポンス集約**: 必要に応じて複数サービスからのレスポンスを結合

### ミドルウェアサポート
1. **認証**: ルーティング前にリクエストの真正性を検証
2. **認可**: リクエストパスとメソッドに基づいて権限をチェック
3. **レート制限**: クライアント/APIキーごとのリクエストレートを制御
4. **リクエスト/レスポンスログ**: 監視とデバッグのためすべてのトラフィックをログ記録
5. **CORS処理**: クロスオリジンリソース共有ポリシーを管理

### ヘルス管理
1. **ヘルスチェック**: バックエンドサービスの健全性を監視
2. **サーキットブレーカー**: カスケード障害を防止
3. **自動フェイルオーバー**: 障害発生時に健全なインスタンスにルーティング

## 非機能要件

### パフォーマンス
- ルーティング決定のレスポンスタイム < 50ms
- 10,000以上の同時接続をサポート
- 最小メモリフットプリント（ベース < 100MB）

### 信頼性
- ルーターサービスの稼働率99.9%
- バックエンドサービス障害時の優雅な劣化
- ゼロダウンタイム設定更新

### セキュリティ
- TLS終端サポート
- リクエスト検証とサニタイゼーション
- 一般的な攻撃（DDoS、インジェクション）からの保護

### 可観測性
- Prometheusメトリクス露出
- 相関IDを使用した構造化ログ
- 分散トレーシングサポート

## 技術的制約

### 技術スタック
- 言語: Go 1.23.0
- Webフレームワーク: 標準ライブラリnet/httpまたはgorilla/mux
- 設定: ホットリロード機能付きYAML/JSON

### 統合ポイント
- HTTP/REST経由のバックエンドサービス
- 動的ルーティングルール用の設定サービス
- 監視システム（Prometheus、Grafana）

### デプロイメント
- コンテナ化デプロイメント（Docker）
- 適切なヘルスエンドポイントを持つKubernetes対応
- 環境ベースの設定

## 成功基準

1. **ルーティング精度**: リクエストの100%が正しいバックエンドにルーティングされる
2. **パフォーマンス**: 通常負荷下でp99レイテンシ < 100ms
3. **可用性**: ルーティング層に単一障害点がない
4. **保守性**: コード変更なしで新しいルートを追加可能
5. **セキュリティ**: 重大な脆弱性なしでセキュリティ監査に合格

## 依存関係

### 外部サービス
- バックエンドAPIサービス（別途開発）
- 設定管理システム
- 認証/認可サービス

### ライブラリ
- HTTPルーティングライブラリ（gorilla/muxまたはchi）
- 共通関心事用ミドルウェアライブラリ
- メトリクスとログライブラリ

## 受け入れ基準

1. ルーターが正常に起動し、設定されたポートでリッスンする
2. ヘルスチェックエンドポイントが200 OKを返す
3. パスパターンに基づいてリクエストが正しくルーティングされる
4. 障害のあるバックエンドサービスがサーキットブレーカーをトリガーする
5. メトリクスがPrometheus形式で公開される
6. 再起動なしで設定を更新できる
7. すべてのミドルウェア機能が期待通りに動作する
8. 負荷分散がトラフィックを均等に分散する

## スコープ外

- ビジネスロジックの実装（バックエンドサービスで処理）
- データベース接続（バックエンドサービスで管理）
- 複雑なリクエスト変換（基本的なプロキシを超えるもの）
- サービスメッシュ機能（必要に応じてIstio/Linkerdを使用）